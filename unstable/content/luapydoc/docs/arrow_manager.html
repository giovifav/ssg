<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>arrow_manager</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="docs_style.css">

<style>
/* Sidebar tree view styles */
#definitions-list.tree { font-size: 0.95em; }
#definitions-list.tree ul { list-style: none; margin-left: 0; padding-left: 0.8rem; border-left: 1px solid rgba(255,255,255,0.08); }
#definitions-list.tree li { margin: 2px 0; position: relative; }
#definitions-list.tree .twisty { border: none; background: none; cursor: pointer; font-size: 12px; width: 1rem; margin-right: 4px; color: #aaa; padding: 0; }
#definitions-list.tree .label { cursor: pointer; }
#definitions-list.tree li.leaf > .twisty { visibility: hidden; }
#definitions-list.tree ul.collapsed { display: none; }
#definitions-list .tree-controls { display: flex; gap: 6px; margin-bottom: 8px; }
#definitions-list .tree-controls button { font-size: 12px; padding: 2px 6px; }
</style>
</head>

<body>
<div class="t-container">
    <aside class="t-col-3">
        <input type="text" id="searchBox" class="t-input" placeholder="Search...">
        <div id="results"></div>

        <div id="definitions-list" class="tree">
            <div class="tree-controls">
                <button id="expandAll" class="t-button">Expand all</button>
                <button id="collapseAll" class="t-button">Collapse all</button>
            </div>
            
<ul>

    
        <li>arrow_manager
<ul>

    
        <li>ArrowManager
<ul>

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.getArrowDirection">getArrowDirection</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.getNormalizedGroupAndBounds">getNormalizedGroupAndBounds</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.getTransformedShape">getTransformedShape</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.mirrorPixels">mirrorPixels</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.new">new</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.rotatePixels">rotatePixels</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager.rotatePixelsArbitrary">rotatePixelsArbitrary</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#ArrowManager:update">update</a></li>
        
    

</ul>
</li>
    

    
        
            
            <li><a href="arrow_manager.html#checkTaperingShape">checkTaperingShape</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#isDiagonalArrow">isDiagonalArrow</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#isHorizontalArrow">isHorizontalArrow</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#isSimpleDiagonalArrow">isSimpleDiagonalArrow</a></li>
        
    

    
        
            
            <li><a href="arrow_manager.html#isVerticalArrow">isVerticalArrow</a></li>
        
    

    
        <li>mod ArrowManager
<ul>

    
        
            
            <li><a href="arrow_manager.html#Utils">Utils</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>collision_manager
<ul>

    
        <li>CollisionManager
<ul>

    
        
            
            <li><a href="collision_manager.html#CollisionManager:checkPlayerMovement">checkPlayerMovement</a></li>
        
    

    
        
            
            <li><a href="collision_manager.html#CollisionManager:getCollisionPixels">getCollisionPixels</a></li>
        
    

    
        
            
            <li><a href="collision_manager.html#CollisionManager.new">new</a></li>
        
    

    
        
            
            <li><a href="collision_manager.html#CollisionManager:resolveEntityCollision">resolveEntityCollision</a></li>
        
    

</ul>
</li>
    

    
        <li>mod CollisionManager
<ul>

    
        
            
            <li><a href="collision_manager.html#CollisionManager">CollisionManager</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>constants
<ul>

    
        
            
            <li><a href="constants.html#constants.Constants">Constants</a></li>
        
    

    
        
            
            <li><a href="constants.html#Constants.COLORS">Constants.COLORS</a></li>
        
    

</ul>
</li>
    

    
        <li>entity
<ul>

    
        <li>Entity
<ul>

    
        
            
            <li><a href="entity.html#Entity:draw">draw</a></li>
        
    

    
        
            
            <li><a href="entity.html#Entity.new">new</a></li>
        
    

    
        
            
            <li><a href="entity.html#Entity:removeFromCollisionMap">removeFromCollisionMap</a></li>
        
    

    
        
            
            <li><a href="entity.html#Entity:setMoving">setMoving</a></li>
        
    

    
        
            
            <li><a href="entity.html#Entity:updateCollisionMapPosition">updateCollisionMapPosition</a></li>
        
    

    
        
            
            <li><a href="entity.html#Entity:updateVisualShape">updateVisualShape</a></li>
        
    

</ul>
</li>
    

    
        <li>mod Entity
<ul>

    
        
            
            <li><a href="entity.html#ArrowManager">ArrowManager</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>game
<ul>

    
        <li>Game
<ul>

    
        
            
            <li><a href="game.html#Game:draw">draw</a></li>
        
    

    
        
            
            <li><a href="game.html#Game:keypressed">keypressed</a></li>
        
    

    
        
            
            <li><a href="game.html#Game.new">new</a></li>
        
    

    
        
            
            <li><a href="game.html#Game:reset">reset</a></li>
        
    

    
        
            
            <li><a href="game.html#Game:update">update</a></li>
        
    

</ul>
</li>
    

    
        <li>mod Game
<ul>

    
        
            
            <li><a href="game.html#Level">Level</a></li>
        
    

</ul>
</li>
    

    
        
            
            <li><a href="game.html#self.collisionManager">self.collisionManager</a></li>
        
    

    
        
            
            <li><a href="game.html#self.currentLevel">self.currentLevel</a></li>
        
    

</ul>
</li>
    

    
        <li>gameover
<ul>

    
        <li>GameOver
<ul>

    
        
            
            <li><a href="gameover.html#GameOver:draw">draw</a></li>
        
    

    
        
            
            <li><a href="gameover.html#GameOver:keypressed">keypressed</a></li>
        
    

    
        
            
            <li><a href="gameover.html#GameOver:load">load</a></li>
        
    

    
        
            
            <li><a href="gameover.html#GameOver.new">new</a></li>
        
    

    
        
            
            <li><a href="gameover.html#GameOver:update">update</a></li>
        
    

</ul>
</li>
    

    
        <li>mod GameOver
<ul>

    
        
            
            <li><a href="gameover.html#GameOver">GameOver</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>level
<ul>

    
        <li>Level
<ul>

    
        
            
            <li><a href="level.html#Level:addEntity">addEntity</a></li>
        
    

    
        
            
            <li><a href="level.html#Level:draw">draw</a></li>
        
    

    
        
            
            <li><a href="level.html#Level:load">load</a></li>
        
    

    
        
            
            <li><a href="level.html#Level.new">new</a></li>
        
    

</ul>
</li>
    

    
        <li>mod Level
<ul>

    
        
            
            <li><a href="level.html#Utils">Utils</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>main
<ul>

    
        
            
            <li><a href="main.html#main.Game">Game</a></li>
        
    

</ul>
</li>
    

    
        <li>scene_manager
<ul>

    
        <li>mod SceneManager
<ul>

    
        
            
            <li><a href="scene_manager.html#SceneManager">SceneManager</a></li>
        
    

</ul>
</li>
    

    
        <li>SceneManager
<ul>

    
        
            
            <li><a href="scene_manager.html#SceneManager:draw">draw</a></li>
        
    

    
        
            
            <li><a href="scene_manager.html#SceneManager:keypressed">keypressed</a></li>
        
    

    
        
            
            <li><a href="scene_manager.html#SceneManager.new">new</a></li>
        
    

    
        
            
            <li><a href="scene_manager.html#SceneManager:reset_game">reset_game</a></li>
        
    

    
        
            
            <li><a href="scene_manager.html#SceneManager:set_scene">set_scene</a></li>
        
    

    
        
            
            <li><a href="scene_manager.html#SceneManager:update">update</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>utils
<ul>

    
        <li>Utils
<ul>

    
        
            
            <li><a href="utils.html#Utils.floodFill">floodFill</a></li>
        
    

    
        
            
            <li><a href="utils.html#Utils.getAABB">getAABB</a></li>
        
    

    
        
            
            <li><a href="utils.html#Utils.getAABBRounded">getAABBRounded</a></li>
        
    

    
        
            
            <li><a href="utils.html#Utils.log">log</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

    
        <li>win
<ul>

    
        <li>mod Win
<ul>

    
        
            
            <li><a href="win.html#Win">Win</a></li>
        
    

</ul>
</li>
    

    
        <li>Win
<ul>

    
        
            
            <li><a href="win.html#Win:draw">draw</a></li>
        
    

    
        
            
            <li><a href="win.html#Win:keypressed">keypressed</a></li>
        
    

    
        
            
            <li><a href="win.html#Win:load">load</a></li>
        
    

    
        
            
            <li><a href="win.html#Win.new">new</a></li>
        
    

    
        
            
            <li><a href="win.html#Win:update">update</a></li>
        
    

</ul>
</li>
    

</ul>
</li>
    

</ul>

        </div>
    </aside>

    <main class="t-col-9">
        <div style="margin-bottom: 10px;">
            <a href="index.html" class="back-link">&larr; Back to Index</a>
        </div>
        <h1 class="t-heading">arrow_manager</h1>
        <div class="tabs">
            <button class="tab-button active" data-tab="doc">Documentation</button>
            <button class="tab-button" data-tab="code">View Code</button>
        </div>

        <div class="tab-content" id="doc" style="display:block;">
            
            
            <div class="func t-card" id="Utils">
                <h2 class="t-heading">Utils</h2>
                <p>Manages movement, shape transforms, direction detection, and collisions for arrow-like entities. This module exposes both pure utility functions and an OO manager for runtime updates.</p>
                <p><em>Type: field</em></p>

                

                

                

                

                

                
                <h3>See also</h3>
                <ul>
                    
                    <li>Level</li>
                    
                </ul>
                

                

                

                
                <p><strong>Class:</strong> mod ArrowManager</p>
                
            </div>
            
            <div class="func t-card" id="ArrowManager.getNormalizedGroupAndBounds">
                <h2 class="t-heading">ArrowManager.getNormalizedGroupAndBounds</h2>
                <p>ArrowManager.getNormalizedGroupAndBounds(group) Helper function to calculate the bounding box of a group of pixels and normalize their coordinates relative to the top-left of the bounding box.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (group): A table of pixel coordinates ({x=x, y=y}).</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(table): normalizedGroup A table of pixel coordinates normalized to (0,0) origin.</li>
                    
                    <li>(table): pixelSet A 2D table for quick lookup of pixel existence in the normalized group.</li>
                    
                    <li>(table): bounds A table containing minX, minY, maxX, maxY, width, and height of the bounding box.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="checkTaperingShape">
                <h2 class="t-heading">checkTaperingShape</h2>
                <p>ArrowManager.checkTaperingShape(normalizedGroup, pixelSet, bounds, isVertical, centerCoord, tipCoord, startCoord, endCoord, stepCoord, getPixelsFunc, getMinMaxFunc, getExpectedSizeFunc) Helper function to check for consistent tapering in arrow shapes (vertical or horizontal).</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (normalizedGroup): The pixel group with coordinates normalized to (0,0) origin.</li>
                    
                    <li><b>table</b> (pixelSet): A 2D table for quick lookup of pixel existence.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                    <li><b>boolean</b> (isVertical): True if checking a vertical arrow, false for horizontal.</li>
                    
                    <li><b>number</b> (centerCoord): The center coordinate (centerX for vertical, centerY for horizontal).</li>
                    
                    <li><b>number</b> (tipCoord): The coordinate of the tip (0 or bounds.height-1 for vertical, 0 or bounds.width-1 for horizontal).</li>
                    
                    <li><b>number</b> (startCoord): The starting coordinate for iteration.</li>
                    
                    <li><b>number</b> (endCoord): The ending coordinate for iteration.</li>
                    
                    <li><b>number</b> (stepCoord): The step direction for iteration (1 or -1).</li>
                    
                    <li><b>function</b> (getPixelsFunc): A function to get pixels along the current row/column.</li>
                    
                    <li><b>function</b> (getMinMaxFunc): A function to get min/max coordinates from a list of pixels.</li>
                    
                    <li><b>function</b> (getExpectedSizeFunc): A function to get the expected size (width/height) for the current row/column.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(boolean): True if the tapering is consistent, otherwise false.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="isVerticalArrow">
                <h2 class="t-heading">isVerticalArrow</h2>
                <p>ArrowManager.isVerticalArrow(normalizedGroup, pixelSet, bounds) Checks if a normalized group of pixels forms a vertical arrow shape. Assumes the arrow has odd width and checks for vertical symmetry and tapering.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (normalizedGroup): The pixel group with coordinates normalized to (0,0) origin.</li>
                    
                    <li><b>table</b> (pixelSet): A 2D table for quick lookup of pixel existence.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(string|nil): "up" or "down" if it's a vertical arrow, otherwise nil.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="isHorizontalArrow">
                <h2 class="t-heading">isHorizontalArrow</h2>
                <p>ArrowManager.isHorizontalArrow(normalizedGroup, pixelSet, bounds) Checks if a normalized group of pixels forms a horizontal arrow shape. Assumes the arrow has odd height and checks for horizontal symmetry and tapering.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (normalizedGroup): The pixel group with coordinates normalized to (0,0) origin.</li>
                    
                    <li><b>table</b> (pixelSet): A 2D table for quick lookup of pixel existence.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(string|nil): "left" or "right" if it's a horizontal arrow, otherwise nil.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="isDiagonalArrow">
                <h2 class="t-heading">isDiagonalArrow</h2>
                <p>ArrowManager.isDiagonalArrow(normalizedGroup, pixelSet, bounds) Checks if a normalized group of pixels forms a diagonal arrow shape. It checks for specific tip and arm configurations for 4 diagonal directions.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (normalizedGroup): The pixel group with coordinates normalized to (0,0) origin.</li>
                    
                    <li><b>table</b> (pixelSet): A 2D table for quick lookup of pixel existence.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(string|nil): "up-right", "up-left", "down-left", or "down-right" if it's a diagonal arrow, otherwise nil.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="isSimpleDiagonalArrow">
                <h2 class="t-heading">isSimpleDiagonalArrow</h2>
                <p>ArrowManager.isSimpleDiagonalArrow(normalizedGroup, pixelSet, bounds) Checks if a normalized group of pixels forms a simple diagonal line.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (normalizedGroup): The pixel group with coordinates normalized to (0,0) origin.</li>
                    
                    <li><b>table</b> (pixelSet): A 2D table for quick lookup of pixel existence.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(string|nil): "up-right", "up-left", "down-left", or "down-right" if it's a diagonal line, otherwise nil.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.getArrowDirection">
                <h2 class="t-heading">ArrowManager.getArrowDirection</h2>
                <p>ArrowManager.getArrowDirection(group) Determines the direction of an arrow shape from a given group of pixels. It first normalizes the group and then checks for vertical, horizontal, and diagonal arrow patterns.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (group): A table of pixel coordinates ({x=x, y=y}) representing a potential arrow.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(string|nil): The direction of the arrow (e.g., "up", "down", "left", "right", "up-right", etc.), or nil if not an arrow.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.rotatePixels">
                <h2 class="t-heading">ArrowManager.rotatePixels</h2>
                <p>ArrowManager.rotatePixels(pixels, angle, bounds) Rotates a group of pixels around the center of its bounding box.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (pixels): A table of pixel coordinates ({x=x, y=y}).</li>
                    
                    <li><b>number</b> (angle): The rotation angle in degrees (e.g., 90, 180, 270).</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(table): A new table of rotated pixel coordinates.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.mirrorPixels">
                <h2 class="t-heading">ArrowManager.mirrorPixels</h2>
                <p>ArrowManager.mirrorPixels(pixels, axis, bounds) Mirrors a group of pixels horizontally or vertically.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (pixels): A table of pixel coordinates ({x=x, y=y}).</li>
                    
                    <li><b>string</b> (axis): "horizontal" or "vertical".</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(table): A new table of mirrored pixel coordinates.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.rotatePixelsArbitrary">
                <h2 class="t-heading">ArrowManager.rotatePixelsArbitrary</h2>
                <p>ArrowManager.rotatePixelsArbitrary(pixels, angle, bounds) Rotates a group of pixels around the center of its bounding box by an arbitrary angle.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (pixels): A table of pixel coordinates ({x=x, y=y}).</li>
                    
                    <li><b>number</b> (angle): The rotation angle in degrees.</li>
                    
                    <li><b>table</b> (bounds): The bounding box information of the pixel group.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(table): A new table of rotated pixel coordinates.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.getTransformedShape">
                <h2 class="t-heading">ArrowManager.getTransformedShape</h2>
                <p>ArrowManager.getTransformedShape(baseShape, baseBounds, fromDirection, toDirection) Transforms a pixel shape from one direction to another.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>table</b> (baseShape): The initial pixel shape (normalized).</li>
                    
                    <li><b>table</b> (baseBounds): The bounding box of the base shape.</li>
                    
                    <li><b>string</b> (fromDirection): The direction the base shape is currently oriented in.</li>
                    
                    <li><b>string</b> (toDirection): The desired final direction.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(table): The transformed pixel shape.</li>
                    
                    <li>(table): The bounds of the transformed shape.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager.new">
                <h2 class="t-heading">ArrowManager.new</h2>
                <p>ArrowManager.new(level, arrowSpeed) Creates a new ArrowManager object.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>Level</b> (level): The current active level object.</li>
                    
                    <li><b>number</b> (arrowSpeed): The base speed of the arrows in pixels per second.</li>
                    
                </ul>
                

                
                <h3>Returns</h3>
                <ul>
                    
                    <li>(ArrowManager): A new ArrowManager instance.</li>
                    
                </ul>
                

                

                

                

                

                

                

                
            </div>
            
            <div class="func t-card" id="ArrowManager:update">
                <h2 class="t-heading">ArrowManager:update</h2>
                <p>ArrowManager:update(dt) Updates the movement of all entities marked as 'isMoving' (arrows). Handles collision detection for moving entities and reverses their direction upon hitting static objects.</p>
                <p><em>Type: function</em></p>

                
                <h3>Parameters</h3>
                <ul>
                    
                    <li><b>number</b> (dt): The time elapsed since the last frame in seconds.</li>
                    
                </ul>
                

                

                

                

                

                

                

                

                
            </div>
            
        </div>

        <div class="tab-content" id="code">
            <div class="lua-highlight"><div class="lua-highlight"><pre><span></span><span class="c1">--- @classmod ArrowManager</span>
<span class="c1">-- Manages movement, shape transforms, direction detection, and collisions for arrow-like entities.</span>
<span class="c1">-- This module exposes both pure utility functions and an OO manager for runtime updates.</span>
<span class="c1">-- @see Level</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">Utils</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="p">(</span><span class="s2">&quot;Utils&quot;</span><span class="p">)</span>
<span class="kd">local</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="nv">ArrowManager</span><span class="p">.</span><span class="py">__index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span>

<span class="c1">--- ArrowManager.getNormalizedGroupAndBounds(group)</span>
<span class="c1">-- Helper function to calculate the bounding box of a group of pixels</span>
<span class="c1">-- and normalize their coordinates relative to the top-left of the bounding box.</span>
<span class="c1">-- @param group table A table of pixel coordinates ({x=x, y=y}).</span>
<span class="c1">-- @return table normalizedGroup A table of pixel coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @return table pixelSet A 2D table for quick lookup of pixel existence in the normalized group.</span>
<span class="c1">-- @return table bounds A table containing minX, minY, maxX, maxY, width, and height of the bounding box.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">minY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="nb">math.huge</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">maxX</span><span class="p">,</span><span class="w"> </span><span class="nv">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="c1">-- Add safety check here</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nb">type</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">)</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nb">error</span><span class="p">(</span><span class="s2">&quot;Invalid pixel coordinate (not a number): x=&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">)</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;, y=&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nb">tostring</span><span class="p">(</span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">))</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">minX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">)</span>
<span class="w">        </span><span class="nv">minY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">minY</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">)</span>
<span class="w">        </span><span class="nv">maxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">maxX</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">)</span>
<span class="w">        </span><span class="nv">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">maxY</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">pixelSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">-- For quick lookup: pixelSet[x][y] = true</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">nx</span><span class="p">,</span><span class="w"> </span><span class="nv">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">minY</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">nx</span><span class="p">,</span>
<span class="w">            </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ny</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">nx</span><span class="p">]</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">nx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">nx</span><span class="p">][</span><span class="nv">ny</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">minX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">minX</span><span class="p">,</span>
<span class="w">        </span><span class="nv">minY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">minY</span><span class="p">,</span>
<span class="w">        </span><span class="nv">maxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">maxX</span><span class="p">,</span>
<span class="w">        </span><span class="nv">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">maxY</span><span class="p">,</span>
<span class="w">        </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">maxX</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">minX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">maxY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">minY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.checkTaperingShape(normalizedGroup, pixelSet, bounds, isVertical, centerCoord, tipCoord, startCoord, endCoord, stepCoord, getPixelsFunc, getMinMaxFunc, getExpectedSizeFunc)</span>
<span class="c1">-- Helper function to check for consistent tapering in arrow shapes (vertical or horizontal).</span>
<span class="c1">-- @param normalizedGroup table The pixel group with coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @param pixelSet table A 2D table for quick lookup of pixel existence.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @param isVertical boolean True if checking a vertical arrow, false for horizontal.</span>
<span class="c1">-- @param centerCoord number The center coordinate (centerX for vertical, centerY for horizontal).</span>
<span class="c1">-- @param tipCoord number The coordinate of the tip (0 or bounds.height-1 for vertical, 0 or bounds.width-1 for horizontal).</span>
<span class="c1">-- @param startCoord number The starting coordinate for iteration.</span>
<span class="c1">-- @param endCoord number The ending coordinate for iteration.</span>
<span class="c1">-- @param stepCoord number The step direction for iteration (1 or -1).</span>
<span class="c1">-- @param getPixelsFunc function A function to get pixels along the current row/column.</span>
<span class="c1">-- @param getMinMaxFunc function A function to get min/max coordinates from a list of pixels.</span>
<span class="c1">-- @param getExpectedSizeFunc function A function to get the expected size (width/height) for the current row/column.</span>
<span class="c1">-- @return boolean True if the tapering is consistent, otherwise false.</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">checkTaperingShape</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">,</span><span class="w"> </span><span class="nv">isVertical</span><span class="p">,</span><span class="w"> </span><span class="nv">centerCoord</span><span class="p">,</span><span class="w"> </span><span class="nv">tipCoord</span><span class="p">,</span><span class="w"> </span><span class="nv">startCoord</span><span class="p">,</span>
<span class="w">    </span><span class="nv">endCoord</span><span class="p">,</span><span class="w"> </span><span class="nv">stepCoord</span><span class="p">,</span><span class="w"> </span><span class="nv">getPixelsFunc</span><span class="p">,</span><span class="w"> </span><span class="nv">getMinMaxFunc</span><span class="p">,</span><span class="w"> </span><span class="nv">getExpectedSizeFunc</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Check for a single pixel tip at the center</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tipPixelExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">isVertical</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">tipPixelExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">centerCoord</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">centerCoord</span><span class="p">][</span><span class="nv">tipCoord</span><span class="p">])</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="nv">tipPixelExists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">tipCoord</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">tipCoord</span><span class="p">][</span><span class="nv">centerCoord</span><span class="p">])</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">tipPixelExists</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">tipPixelCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">isVertical</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">tipCoord</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="nv">isVertical</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">tipCoord</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">tipPixelCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tipPixelCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">tipPixelCount</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Check for consistent tapering</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentCoord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">startCoord</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">-- distance from tip row/column</span>
<span class="w">    </span><span class="kr">while</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">expectedMin</span><span class="p">,</span><span class="w"> </span><span class="nv">expectedMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">getExpectedSizeFunc</span><span class="p">(</span><span class="nv">centerCoord</span><span class="p">,</span><span class="w"> </span><span class="nv">k</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">expectedSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">expectedMax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">expectedMin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentPixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">getPixelsFunc</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">currentCoord</span><span class="p">)</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">currentPixels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span><span class="w"> </span><span class="c1">-- Gap in the arrow</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentMin</span><span class="p">,</span><span class="w"> </span><span class="nv">currentMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">getMinMaxFunc</span><span class="p">(</span><span class="nv">currentPixels</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentMax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">currentMin</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">currentSize</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">expectedSize</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">currentMin</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">expectedMin</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">currentMax</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">expectedMax</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">currentCoord</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">endCoord</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">break</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nv">currentCoord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentCoord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">stepCoord</span>
<span class="w">        </span><span class="nv">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.isVerticalArrow(normalizedGroup, pixelSet, bounds)</span>
<span class="c1">-- Checks if a normalized group of pixels forms a vertical arrow shape.</span>
<span class="c1">-- Assumes the arrow has odd width and checks for vertical symmetry and tapering.</span>
<span class="c1">-- @param normalizedGroup table The pixel group with coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @param pixelSet table A 2D table for quick lookup of pixel existence.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return string|nil &quot;up&quot; or &quot;down&quot; if it&#39;s a vertical arrow, otherwise nil.</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">isVerticalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">end</span><span class="w"> </span><span class="c1">-- Width must be odd</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Check for vertical symmetry</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">symX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">symX</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">symX</span><span class="p">][</span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">])</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getRowPixels</span><span class="p">(</span><span class="nv">group</span><span class="p">,</span><span class="w"> </span><span class="nv">yCoord</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">pixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">yCoord</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">pixels</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">pixels</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getMinMaxX</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">maxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">minX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">            </span><span class="nv">maxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">maxX</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">minX</span><span class="p">,</span><span class="w"> </span><span class="nv">maxX</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getExpectedXSize</span><span class="p">(</span><span class="nv">center</span><span class="p">,</span><span class="w"> </span><span class="nv">k</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">k</span><span class="p">,</span><span class="w"> </span><span class="nv">center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">k</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkTaperingShape</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">centerX</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nv">getRowPixels</span><span class="p">,</span><span class="w"> </span><span class="nv">getMinMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">getExpectedXSize</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;up&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkTaperingShape</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nv">centerX</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nv">getRowPixels</span><span class="p">,</span><span class="w"> </span><span class="nv">getMinMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">getExpectedXSize</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;down&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.isHorizontalArrow(normalizedGroup, pixelSet, bounds)</span>
<span class="c1">-- Checks if a normalized group of pixels forms a horizontal arrow shape.</span>
<span class="c1">-- Assumes the arrow has odd height and checks for horizontal symmetry and tapering.</span>
<span class="c1">-- @param normalizedGroup table The pixel group with coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @param pixelSet table A 2D table for quick lookup of pixel existence.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return string|nil &quot;left&quot; or &quot;right&quot; if it&#39;s a horizontal arrow, otherwise nil.</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">isHorizontalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="kr">end</span><span class="w"> </span><span class="c1">-- Height must be odd</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Check for horizontal symmetry</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">symY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">][</span><span class="nv">symY</span><span class="p">])</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getColPixels</span><span class="p">(</span><span class="nv">group</span><span class="p">,</span><span class="w"> </span><span class="nv">xCoord</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">pixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">xCoord</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">pixels</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">pixels</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getMinMaxY</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">minY</span><span class="p">,</span><span class="w"> </span><span class="nv">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">minY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">minY</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">            </span><span class="nv">maxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">maxY</span><span class="p">,</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">minY</span><span class="p">,</span><span class="w"> </span><span class="nv">maxY</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">getExpectedYSize</span><span class="p">(</span><span class="nv">center</span><span class="p">,</span><span class="w"> </span><span class="nv">k</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">center</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">k</span><span class="p">,</span><span class="w"> </span><span class="nv">center</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">k</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkTaperingShape</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nv">centerY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nv">getColPixels</span><span class="p">,</span><span class="w"> </span><span class="nv">getMinMaxY</span><span class="p">,</span><span class="w"> </span><span class="nv">getExpectedYSize</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;left&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkTaperingShape</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nv">centerY</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nv">getColPixels</span><span class="p">,</span><span class="w"> </span><span class="nv">getMinMaxY</span><span class="p">,</span><span class="w"> </span><span class="nv">getExpectedYSize</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;right&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.isDiagonalArrow(normalizedGroup, pixelSet, bounds)</span>
<span class="c1">-- Checks if a normalized group of pixels forms a diagonal arrow shape.</span>
<span class="c1">-- It checks for specific tip and arm configurations for 4 diagonal directions.</span>
<span class="c1">-- @param normalizedGroup table The pixel group with coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @param pixelSet table A 2D table for quick lookup of pixel existence.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return string|nil &quot;up-right&quot;, &quot;up-left&quot;, &quot;down-left&quot;, or &quot;down-right&quot; if it&#39;s a diagonal arrow, otherwise nil.</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">isDiagonalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">checkDiagonalArrowShape</span><span class="p">(</span><span class="nv">tipX</span><span class="p">,</span><span class="w"> </span><span class="nv">tipY</span><span class="p">,</span><span class="w"> </span><span class="nv">dir1X</span><span class="p">,</span><span class="w"> </span><span class="nv">dir1Y</span><span class="p">,</span><span class="w"> </span><span class="nv">dir2X</span><span class="p">,</span><span class="w"> </span><span class="nv">dir2Y</span><span class="p">)</span>
<span class="w">        </span><span class="c1">-- Check if the tip pixel exists</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">tipX</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">tipX</span><span class="p">][</span><span class="nv">tipY</span><span class="p">])</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check for the first arm</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentX</span><span class="p">,</span><span class="w"> </span><span class="nv">currentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tipX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1X</span><span class="p">,</span><span class="w"> </span><span class="nv">tipY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1Y</span>
<span class="w">        </span><span class="kr">while</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">currentX</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">currentX</span><span class="p">][</span><span class="nv">currentY</span><span class="p">]</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">len1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="nv">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1X</span>
<span class="w">            </span><span class="nv">currentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1Y</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check for the second arm</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">len2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nv">currentX</span><span class="p">,</span><span class="w"> </span><span class="nv">currentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tipX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2X</span><span class="p">,</span><span class="w"> </span><span class="nv">tipY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2Y</span>
<span class="w">        </span><span class="kr">while</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">currentX</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">[</span><span class="nv">currentX</span><span class="p">][</span><span class="nv">currentY</span><span class="p">]</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">len2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">len2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="nv">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2X</span>
<span class="w">            </span><span class="nv">currentY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2Y</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Both arms must have length &gt; 0 and be equal</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">len2</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Verify that all pixels in the normalizedGroup belong to the tip and these two arms</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">expectedPixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">tipX</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">tipX</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">tipX</span><span class="p">][</span><span class="nv">tipY</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="w">        </span><span class="c1">-- Add pixels from the first arm</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">cx</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tipX</span><span class="p">,</span><span class="w"> </span><span class="nv">tipY</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">cx</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1X</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir1Y</span>
<span class="w">            </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">][</span><span class="nv">cy</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Add pixels from the second arm</span>
<span class="w">        </span><span class="nv">cx</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">tipX</span><span class="p">,</span><span class="w"> </span><span class="nv">tipY</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">len2</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nv">cx</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">cx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2X</span><span class="p">,</span><span class="w"> </span><span class="nv">cy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">dir2Y</span>
<span class="w">            </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">]</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">cx</span><span class="p">][</span><span class="nv">cy</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check if all pixels in the group are accounted for</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">normalizedGroup</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">len1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">len2</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">]</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">expectedPixels</span><span class="p">[</span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">][</span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">])</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="kr">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- up-right: tip at (bounds.width - 1, 0), arms go left and down</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkDiagonalArrowShape</span><span class="p">(</span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- up-left: tip at (0, 0), arms go right and down</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkDiagonalArrowShape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- down-left: tip at (0, bounds.height - 1), arms go right and up</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkDiagonalArrowShape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- down-right: tip at (bounds.width - 1, bounds.height - 1), arms go left and up</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">checkDiagonalArrowShape</span><span class="p">(</span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.isSimpleDiagonalArrow(normalizedGroup, pixelSet, bounds)</span>
<span class="c1">-- Checks if a normalized group of pixels forms a simple diagonal line.</span>
<span class="c1">-- @param normalizedGroup table The pixel group with coordinates normalized to (0,0) origin.</span>
<span class="c1">-- @param pixelSet table A 2D table for quick lookup of pixel existence.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return string|nil &quot;up-right&quot;, &quot;up-left&quot;, &quot;down-left&quot;, or &quot;down-right&quot; if it&#39;s a diagonal line, otherwise nil.</span>
<span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">isSimpleDiagonalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- Check if pixels form a straight diagonal line</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">normalizedGroup</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Sort pixels by x coordinate to ensure consistent checking</span>
<span class="w">    </span><span class="nb">table.sort</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">a</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">b</span><span class="p">.</span><span class="py">x</span>
<span class="w">    </span><span class="kr">end</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Check if all pixels are in a diagonal line</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">isUpRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">isUpLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">isDownRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">isDownLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="nv">normalizedGroup</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="p">[</span><span class="nv">i</span><span class="p">]</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="p">[</span><span class="nv">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>

<span class="w">        </span><span class="c1">-- Check up-right diagonal</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">p2</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p2</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">isUpRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check up-left diagonal</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">p2</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p2</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">isUpLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check down-right diagonal</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">p2</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p2</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">isDownRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check down-left diagonal</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="p">(</span><span class="nv">p2</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">p2</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">p1</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">isDownLeft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">isUpRight</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">isUpLeft</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">isDownRight</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">isDownLeft</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.getArrowDirection(group)</span>
<span class="c1">-- Determines the direction of an arrow shape from a given group of pixels.</span>
<span class="c1">-- It first normalizes the group and then checks for vertical, horizontal, and diagonal arrow patterns.</span>
<span class="c1">-- @param group table A table of pixel coordinates ({x=x, y=y}) representing a potential arrow.</span>
<span class="c1">-- @return string|nil The direction of the arrow (e.g., &quot;up&quot;, &quot;down&quot;, &quot;left&quot;, &quot;right&quot;, &quot;up-right&quot;, etc.), or nil if not an arrow.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">getArrowDirection</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span>
<span class="w">    </span><span class="c1">-- Define a reasonable maximum size for an arrow group to prevent misidentification of large objects.</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">Constants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">require</span><span class="p">(</span><span class="s2">&quot;constants&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">group</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">group</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nv">Constants</span><span class="p">.</span><span class="py">MAX_ARROW_PIXELS</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">group</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">Constants</span><span class="p">.</span><span class="py">MIN_ARROW_PIXELS</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">group</span><span class="p">)</span>

<span class="w">    </span><span class="c1">-- Add this safety check</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">#</span><span class="nv">normalizedGroup</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>

<span class="w">    </span><span class="c1">-- Check for all directions</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">verticalDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">isVerticalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">verticalDir</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">verticalDir</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">horizontalDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">isHorizontalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">horizontalDir</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">horizontalDir</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">diagonalDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">isDiagonalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">diagonalDir</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">diagonalDir</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Add check for simple diagonal arrows</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">simpleDiagonalDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">isSimpleDiagonalArrow</span><span class="p">(</span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">pixelSet</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">simpleDiagonalDir</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">simpleDiagonalDir</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">detectedDirection</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- Return the detected shape and bounds directly, not a canonical one.</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">detectedDirection</span><span class="p">,</span><span class="w"> </span><span class="nv">normalizedGroup</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.rotatePixels(pixels, angle, bounds)</span>
<span class="c1">-- Rotates a group of pixels around the center of its bounding box.</span>
<span class="c1">-- @param pixels table A table of pixel coordinates ({x=x, y=y}).</span>
<span class="c1">-- @param angle number The rotation angle in degrees (e.g., 90, 180, 270).</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return table A new table of rotated pixel coordinates.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">pixels</span><span class="p">,</span><span class="w"> </span><span class="nv">angle</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="c1">-- Use exact integer mappings for 90/180/270 to avoid rounding artifacts</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">angle</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">360</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- 90 deg clockwise: (x, y) -&gt; (H-1 - y, x)</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rotated</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">,</span>
<span class="w">                </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">rotated</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">angle</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">360</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">180</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- 180 deg: (x, y) -&gt; (W-1 - x, H-1 - y)</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rotated</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="p">,</span>
<span class="w">                </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">rotated</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">angle</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">360</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">270</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- 270 deg clockwise: (x, y) -&gt; (y, W-1 - x)</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rotated</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="p">,</span>
<span class="w">                </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">rotated</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Fallback for non-right-angle rotations (should rarely be used here)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">cos_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="nb">math.rad</span><span class="p">(</span><span class="nv">angle</span><span class="p">))</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sin_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="nb">math.rad</span><span class="p">(</span><span class="nv">angle</span><span class="p">))</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">centerX</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">centerY</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cos_angle</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">sin_angle</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">sin_angle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cos_angle</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rotated</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">centerX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">            </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">centerY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">rotated</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.mirrorPixels(pixels, axis, bounds)</span>
<span class="c1">-- Mirrors a group of pixels horizontally or vertically.</span>
<span class="c1">-- @param pixels table A table of pixel coordinates ({x=x, y=y}).</span>
<span class="c1">-- @param axis string &quot;horizontal&quot; or &quot;vertical&quot;.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return table A new table of mirrored pixel coordinates.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">mirrorPixels</span><span class="p">(</span><span class="nv">pixels</span><span class="p">,</span><span class="w"> </span><span class="nv">axis</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">mirrored</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;horizontal&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">        </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">axis</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;vertical&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">mirrored</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">newX</span><span class="p">,</span>
<span class="w">            </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">newY</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">mirrored</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.rotatePixelsArbitrary(pixels, angle, bounds)</span>
<span class="c1">-- Rotates a group of pixels around the center of its bounding box by an arbitrary angle.</span>
<span class="c1">-- @param pixels table A table of pixel coordinates ({x=x, y=y}).</span>
<span class="c1">-- @param angle number The rotation angle in degrees.</span>
<span class="c1">-- @param bounds table The bounding box information of the pixel group.</span>
<span class="c1">-- @return table A new table of rotated pixel coordinates.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixelsArbitrary</span><span class="p">(</span><span class="nv">pixels</span><span class="p">,</span><span class="w"> </span><span class="nv">angle</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">width</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">centerY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">bounds</span><span class="p">.</span><span class="py">height</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">cos_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.cos</span><span class="p">(</span><span class="nb">math.rad</span><span class="p">(</span><span class="nv">angle</span><span class="p">))</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">sin_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.sin</span><span class="p">(</span><span class="nb">math.rad</span><span class="p">(</span><span class="nv">angle</span><span class="p">))</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="c1">-- Translate pixel to origin</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">centerX</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">centerY</span>

<span class="w">        </span><span class="c1">-- Rotate</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cos_angle</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">sin_angle</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">newY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">translatedX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">sin_angle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">translatedY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">cos_angle</span>

<span class="w">        </span><span class="c1">-- Translate back</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">rotated</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">newX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">centerX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">            </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">newY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">centerY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">rotated</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.getTransformedShape(baseShape, baseBounds, fromDirection, toDirection)</span>
<span class="c1">-- Transforms a pixel shape from one direction to another.</span>
<span class="c1">-- @param baseShape table The initial pixel shape (normalized).</span>
<span class="c1">-- @param baseBounds table The bounding box of the base shape.</span>
<span class="c1">-- @param fromDirection string The direction the base shape is currently oriented in.</span>
<span class="c1">-- @param toDirection string The desired final direction.</span>
<span class="c1">-- @return table The transformed pixel shape.</span>
<span class="c1">-- @return table The bounds of the transformed shape.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">getTransformedShape</span><span class="p">(</span><span class="nv">baseShape</span><span class="p">,</span><span class="w"> </span><span class="nv">baseBounds</span><span class="p">,</span><span class="w"> </span><span class="nv">fromDirection</span><span class="p">,</span><span class="w"> </span><span class="nv">toDirection</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="kr">function</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">dir</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">dir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="c1">-- Fast path: diagonal-to-diagonal reorientation via exact 90° rotations</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">fromDirection</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">toDirection</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;up-right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;down-right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;down-left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;up-left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">index</span><span class="p">[</span><span class="nv">toDirection</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">index</span><span class="p">[</span><span class="nv">fromDirection</span><span class="p">])</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">90</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">rotated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">baseShape</span><span class="p">,</span><span class="w"> </span><span class="nv">angle</span><span class="p">,</span><span class="w"> </span><span class="nv">baseBounds</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">normalizedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">newBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">rotated</span><span class="p">)</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="nv">normalizedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">newBounds</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">transformedShape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">baseShape</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">baseBounds</span>

<span class="w">    </span><span class="c1">-- Define transformations to a canonical &quot;right&quot; arrow</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">toCanonicalRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">270</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">mirrorPixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">shape</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Already canonical</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">-- Define transformations from canonical &quot;right&quot; arrow to target direction</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">fromCanonicalRight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">270</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">mirrorPixels</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">function</span><span class="p">(</span><span class="nv">shape</span><span class="p">,</span><span class="w"> </span><span class="nv">bounds</span><span class="p">)</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nv">shape</span><span class="w"> </span><span class="kr">end</span><span class="p">,</span><span class="w"> </span><span class="c1">-- Already canonical</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">fromDirection</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">toDirection</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- Step 1: Transform from &#39;fromDirection&#39; to a canonical &quot;right&quot; facing arrow</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">toCanonicalRight</span><span class="p">[</span><span class="nv">fromDirection</span><span class="p">](</span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="p">)</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">transformedShape</span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- Step 2: Transform from canonical &quot;right&quot; to &#39;toDirection&#39;</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">fromCanonicalRight</span><span class="p">[</span><span class="nv">toDirection</span><span class="p">](</span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="p">)</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">transformedShape</span><span class="p">)</span>
<span class="w">    </span><span class="kr">elseif</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">fromDirection</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nf">isDiagonal</span><span class="p">(</span><span class="nv">toDirection</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="c1">-- This block remains as is for diagonal-to-diagonal transformations</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;up-right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;down-right&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;down-left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;up-left&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">index</span><span class="p">[</span><span class="nv">toDirection</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">index</span><span class="p">[</span><span class="nv">fromDirection</span><span class="p">])</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">steps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">90</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">rotatePixels</span><span class="p">(</span><span class="nv">baseShape</span><span class="p">,</span><span class="w"> </span><span class="nv">angle</span><span class="p">,</span><span class="w"> </span><span class="nv">baseBounds</span><span class="p">)</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">transformedShape</span><span class="p">)</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="c1">-- If attempting to convert between diagonal and non-diagonal, return current normalized shape</span>
<span class="w">        </span><span class="c1">-- as direct conversion is not yet supported and would lead to distortions.</span>
<span class="w">        </span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">.</span><span class="nf">getNormalizedGroupAndBounds</span><span class="p">(</span><span class="nv">baseShape</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">transformedShape</span><span class="p">,</span><span class="w"> </span><span class="nv">transformedBounds</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager.new(level, arrowSpeed)</span>
<span class="c1">-- Creates a new ArrowManager object.</span>
<span class="c1">-- @param level Level The current active level object.</span>
<span class="c1">-- @param arrowSpeed number The base speed of the arrows in pixels per second.</span>
<span class="c1">-- @return ArrowManager A new ArrowManager instance.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nv">level</span><span class="p">,</span><span class="w"> </span><span class="nv">arrowSpeed</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">setmetatable</span><span class="p">({},</span><span class="w"> </span><span class="nv">ArrowManager</span><span class="p">)</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">level</span>
<span class="w">    </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arrowSpeed</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="nv">self</span>
<span class="kr">end</span>

<span class="c1">--- ArrowManager:update(dt)</span>
<span class="c1">-- Updates the movement of all entities marked as &#39;isMoving&#39; (arrows).</span>
<span class="c1">-- Handles collision detection for moving entities and reverses their direction upon hitting static objects.</span>
<span class="c1">-- @param dt number The time elapsed since the last frame in seconds.</span>
<span class="kr">function</span><span class="w"> </span><span class="nc">ArrowManager</span><span class="p">:</span><span class="nf">update</span><span class="p">(</span><span class="nv">dt</span><span class="p">)</span>
<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">allMovingEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">entities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">isMoving</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">allMovingEntities</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">playerArrows</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">allMovingEntities</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">gameOver</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="kr">return</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kd">local</span><span class="w"> </span><span class="nv">allMovingEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">entities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">isMoving</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">allMovingEntities</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">playerArrows</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">allMovingEntities</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="p">)</span>
<span class="w">    </span><span class="kr">end</span>

<span class="w">    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">allMovingEntities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;right&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span><span class="p">,</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span><span class="p">,</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">arrowSpeed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">hitX</span><span class="p">,</span><span class="w"> </span><span class="nv">hitY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">-- for diagonal collisions: which axis collided</span>

<span class="w">        </span><span class="c1">-- Get collision pixels based on arrow type and potential target</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">collisionPixelsToCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">collisionMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;aabb&quot;</span><span class="w"> </span><span class="c1">-- Default to AABB for most arrow-solid object collisions</span>

<span class="w">        </span><span class="c1">-- Determine collision mode based on entity types</span>
<span class="w">        </span><span class="c1">-- If it&#39;s a player_arrow potentially colliding with a player, use pixel_perfect</span>
<span class="w">        </span><span class="c1">-- This requires checking against all player-controlled entities</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">isPlayerArrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">entity</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;player_arrow&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">isCollidingWithPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">playerEntity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">playerControlledEntities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="c1">-- Check if the arrow&#39;s bounding box (next position) overlaps with the player&#39;s bounding box (current position)</span>
<span class="w">            </span><span class="c1">-- This is a broad phase check to decide if we need pixel-perfect</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">arrowMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">arrowMinY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="nb">math.huge</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">arrowMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">arrowMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">entity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="nv">arrowMinX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">arrowMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="p">)</span>
<span class="w">                </span><span class="nv">arrowMinY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">arrowMinY</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="p">)</span>
<span class="w">                </span><span class="nv">arrowMaxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">arrowMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="p">)</span>
<span class="w">                </span><span class="nv">arrowMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">arrowMaxY</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowMinX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arrowMinX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDx</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowMinY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arrowMinY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDy</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowMaxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arrowMaxX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDx</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">arrowMaxY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDy</span>

<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">playerMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">playerMinY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="nb">math.huge</span>
<span class="w">            </span><span class="kd">local</span><span class="w"> </span><span class="nv">playerMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">playerMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="nb">math.huge</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">playerEntity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="nv">playerMinX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">playerMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="p">)</span>
<span class="w">                </span><span class="nv">playerMinY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.min</span><span class="p">(</span><span class="nv">playerMinY</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="p">)</span>
<span class="w">                </span><span class="nv">playerMaxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">playerMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="p">)</span>
<span class="w">                </span><span class="nv">playerMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.max</span><span class="p">(</span><span class="nv">playerMaxY</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="p">)</span>
<span class="w">            </span><span class="kr">end</span>

<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">nextArrowMaxX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">playerMinX</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">nextArrowMinX</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nv">playerMaxX</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">nextArrowMaxY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">playerMinY</span><span class="w"> </span><span class="ow">and</span>
<span class="w">                </span><span class="nv">nextArrowMinY</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nv">playerMaxY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="nv">isCollidingWithPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                </span><span class="kr">break</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">isPlayerArrow</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">isCollidingWithPlayer</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="nv">collisionMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;pixel_perfect&quot;</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Get collision pixels using the determined mode</span>
<span class="w">        </span><span class="nv">collisionPixelsToCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">collisionManager</span><span class="p">:</span><span class="nf">getCollisionPixels</span><span class="p">(</span><span class="nv">entity</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="p">,</span><span class="w"> </span><span class="nv">collisionMode</span><span class="p">)</span>

<span class="w">        </span><span class="c1">-- Store all pixels for actual movement if no collision</span>
<span class="w">        </span><span class="kd">local</span><span class="w"> </span><span class="nv">allNextPixels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">entity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">            </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">allNextPixels</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nv">newFloatX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDx</span><span class="p">,</span>
<span class="w">                </span><span class="nv">newFloatY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDy</span><span class="p">,</span>
<span class="w">                </span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">                </span><span class="nv">nextGridY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">                </span><span class="nv">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="c1">-- Check for collisions using the determined collision pixels</span>
<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="nv">collisionMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;pixel_perfect&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="c1">-- For pixel-perfect collision with player, check every pixel of the arrow against every pixel of the player</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">playerEntity</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">playerControlledEntities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">playerEntity</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="c1">-- Ensure not colliding with itself</span>
<span class="w">                    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">arrowPixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">entity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                        </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowGridX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">arrowPixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                        </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextArrowGridY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">arrowPixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">moveDy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>

<span class="w">                        </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">playerPixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">playerEntity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                            </span><span class="kd">local</span><span class="w"> </span><span class="nv">playerGridX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">playerPixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                            </span><span class="kd">local</span><span class="w"> </span><span class="nv">playerGridY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">playerPixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>

<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">nextArrowGridX</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">playerGridX</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">nextArrowGridY</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">playerGridY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">playerEntity</span>
<span class="w">                                </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                                </span><span class="kr">break</span><span class="w"> </span><span class="c1">-- Found a collision, no need to check more pixels for this arrow-player pair</span>
<span class="w">                            </span><span class="kr">end</span>
<span class="w">                        </span><span class="kr">end</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="kr">break</span>
<span class="w">                        </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="kr">break</span>
<span class="w">                </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">else</span><span class="w"> </span><span class="c1">-- AABB collision or default</span>
<span class="w">            </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">collisionPixelsToCheck</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">x</span>
<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">nextGridY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">p</span><span class="p">.</span><span class="py">y</span>

<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">outX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">levelData</span><span class="p">:</span><span class="nf">getWidth</span><span class="p">())</span>
<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">outY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">nextGridY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">nextGridY</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">levelData</span><span class="p">:</span><span class="nf">getHeight</span><span class="p">())</span>

<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">outX</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">outY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">outX</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">hitX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">outY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">hitY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">break</span>
<span class="w">                </span><span class="kr">end</span>

<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">currentCollidedEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">collisionMap</span><span class="p">[</span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">nextGridY</span><span class="p">]</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">currentCollidedEntity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">currentCollidedEntity</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">currentCollidedEntity</span><span class="p">.</span><span class="py">isMoving</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">currentCollidedEntity</span>
<span class="w">                    </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>

<span class="w">                    </span><span class="c1">-- Determine collision axis for diagonal arrows (only relevant for AABB/solid objects)</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span>
<span class="w">                        </span><span class="s2">&quot;up-left&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="c1">-- Check for horizontal-only collision</span>
<span class="w">                        </span><span class="kd">local</span><span class="w"> </span><span class="nv">tempMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMinY</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Utils</span><span class="p">.</span><span class="nf">getAABB</span><span class="p">(</span><span class="nv">entity</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                        </span><span class="kr">for</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMinY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMaxY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                            </span><span class="kr">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMinX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMaxX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                                </span><span class="kd">local</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">collisionMap</span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">y</span><span class="p">]</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">collision</span><span class="p">.</span><span class="py">isMoving</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="nv">hitX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                                    </span><span class="kr">break</span>
<span class="w">                                </span><span class="kr">end</span>
<span class="w">                            </span><span class="kr">end</span>
<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">hitX</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="kr">break</span>
<span class="w">                            </span><span class="kr">end</span>
<span class="w">                        </span><span class="kr">end</span>

<span class="w">                        </span><span class="c1">-- Check for vertical-only collision</span>
<span class="w">                        </span><span class="kd">local</span><span class="w"> </span><span class="nv">tempMinX</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMinY</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMaxX</span><span class="p">,</span><span class="w"> </span><span class="nv">tempMaxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">Utils</span><span class="p">.</span><span class="nf">getAABB</span><span class="p">(</span><span class="nv">entity</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">moveDy</span><span class="p">)</span>
<span class="w">                        </span><span class="kr">for</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMinY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMaxY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                            </span><span class="kr">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMinX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">tempMaxX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                                </span><span class="kd">local</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">collisionMap</span><span class="p">[</span><span class="nv">x</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="nv">y</span><span class="p">]</span>
<span class="w">                                </span><span class="kr">if</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">collision</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">collision</span><span class="p">.</span><span class="py">isMoving</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                    </span><span class="nv">hitY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                                    </span><span class="kr">break</span>
<span class="w">                                </span><span class="kr">end</span>
<span class="w">                            </span><span class="kr">end</span>
<span class="w">                            </span><span class="kr">if</span><span class="w"> </span><span class="nv">hitY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                                </span><span class="kr">break</span>
<span class="w">                            </span><span class="kr">end</span>
<span class="w">                        </span><span class="kr">end</span>

<span class="w">                        </span><span class="c1">-- If a collision was detected but neither axis was specifically hit, assume both</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">hitX</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">hitY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="nv">hitX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                            </span><span class="nv">hitY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                        </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">end</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nv">entityCanMove</span><span class="w"> </span><span class="kr">then</span>
<span class="w">            </span><span class="kr">if</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">hitX</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">hitY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                </span><span class="c1">-- Game over: player_arrow against enemy, or any arrow against player</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="ow">and</span>
<span class="w">                    </span><span class="p">((</span><span class="nv">entity</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;player_arrow&quot;</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;enemy&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span>
<span class="w">                        </span><span class="p">(</span><span class="nv">collidedEntity</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;player&quot;</span><span class="p">))</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">gameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                    </span><span class="kr">return</span>
<span class="w">                </span><span class="kr">end</span>

<span class="w">                </span><span class="kd">local</span><span class="w"> </span><span class="nv">oldDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span>
<span class="w">                </span><span class="c1">-- Bounce logic</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span><span class="w"> </span><span class="ow">or</span>
<span class="w">                    </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">diag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span>
<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">diag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">diag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">diag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">diag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">hitX</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">dx</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">hitY</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">dy</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;up-right&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;down-right&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;up-left&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">dy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;down-left&quot;</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">else</span>
<span class="w">                    </span><span class="kr">if</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;up&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;down&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;down&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;up&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;left&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;right&quot;</span>
<span class="w">                    </span><span class="kr">elseif</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;right&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                        </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;left&quot;</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                </span><span class="kr">end</span>

<span class="w">                </span><span class="c1">-- Trigger hit → remove</span>
<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="p">.</span><span class="py">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;trigger&quot;</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="nv">collidedEntity</span><span class="p">:</span><span class="nf">removeFromCollisionMap</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">)</span>
<span class="w">                    </span><span class="kr">for</span><span class="w"> </span><span class="nv">i</span><span class="p">,</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">entities</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                        </span><span class="kr">if</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">collidedEntity</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                            </span><span class="nb">table.remove</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">entities</span><span class="p">,</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">                            </span><span class="kr">break</span>
<span class="w">                        </span><span class="kr">end</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">remainingTriggers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">.</span><span class="py">remainingTriggers</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                </span><span class="kr">end</span>

<span class="w">                </span><span class="kr">if</span><span class="w"> </span><span class="nv">oldDirection</span><span class="w"> </span><span class="o">~=</span><span class="w"> </span><span class="nv">entity</span><span class="p">.</span><span class="py">direction</span><span class="w"> </span><span class="kr">then</span>
<span class="w">                    </span><span class="c1">-- Move entity back by the exact amount it moved in this frame to prevent penetration</span>
<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">reverseDx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">moveDx</span>
<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">reverseDy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nv">moveDy</span>

<span class="w">                    </span><span class="kd">local</span><span class="w"> </span><span class="nv">reversePixelsData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                    </span><span class="kr">for</span><span class="w"> </span><span class="nv">_</span><span class="p">,</span><span class="w"> </span><span class="nv">pixel</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nb">ipairs</span><span class="p">(</span><span class="nv">entity</span><span class="p">.</span><span class="py">pixels</span><span class="p">)</span><span class="w"> </span><span class="kr">do</span>
<span class="w">                        </span><span class="nb">table.insert</span><span class="p">(</span><span class="nv">reversePixelsData</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="nv">newFloatX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">reverseDx</span><span class="p">,</span>
<span class="w">                            </span><span class="nv">newFloatY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">reverseDy</span><span class="p">,</span>
<span class="w">                            </span><span class="nv">nextGridX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">reverseDx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">                            </span><span class="nv">nextGridY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">math.floor</span><span class="p">(</span><span class="nv">pixel</span><span class="p">.</span><span class="py">floatY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">reverseDy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span>
<span class="w">                            </span><span class="nv">original</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pixel</span>
<span class="w">                        </span><span class="p">})</span>
<span class="w">                    </span><span class="kr">end</span>
<span class="w">                    </span><span class="nv">entity</span><span class="p">:</span><span class="nf">updateCollisionMapPosition</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">,</span><span class="w"> </span><span class="nv">reversePixelsData</span><span class="p">)</span>
<span class="w">                    </span><span class="nv">entity</span><span class="p">:</span><span class="nf">updateVisualShape</span><span class="p">()</span>
<span class="w">                </span><span class="kr">end</span>
<span class="w">            </span><span class="kr">end</span>
<span class="w">        </span><span class="kr">else</span>
<span class="w">            </span><span class="c1">-- Actual movement</span>
<span class="w">            </span><span class="nv">entity</span><span class="p">:</span><span class="nf">updateCollisionMapPosition</span><span class="p">(</span><span class="nv">self</span><span class="p">.</span><span class="py">level</span><span class="p">,</span><span class="w"> </span><span class="nv">allNextPixels</span><span class="p">)</span>
<span class="w">        </span><span class="kr">end</span>
<span class="w">    </span><span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">return</span><span class="w"> </span><span class="nv">ArrowManager</span>
</pre></div>
</div>
        </div>
    </main>
</div>

<script>
// Tabs
document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display='none');
        const targetTab = document.getElementById(btn.dataset.tab);
        targetTab.style.display='block';
    });
});

// Search with robust index loading (fallback to DOM if fetch fails)
let searchIndex = [];
const searchBox = document.getElementById("searchBox");
const resultsDiv = document.getElementById("results");

async function loadSearchIndex(){
    try {
        const res = await fetch("search.json", { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        searchIndex = await res.json();
    } catch (e) {
        // Fallback: build index from sidebar anchors (works also with file://)
        const anchors = Array.from(document.querySelectorAll('#definitions-list a[href]'));
        searchIndex = anchors.map(a => {
            const href = a.getAttribute('href') || '';
            const m = href.match(/([^\/\\]+)\.html#(.+)$/);
            return {
                file: m ? m[1] : '',
                full_name: m ? m[2] : a.textContent.trim(),
                class: null,
                summary: a.textContent.trim(),
                params: [],
                returns: []
            };
        });
    }
}

loadSearchIndex();

function scrollHighlight(id){
    const el=document.getElementById(id);
    if(el){ el.scrollIntoView({behavior:"smooth", block:"center"}); el.classList.add("highlight");
        setTimeout(()=>el.classList.remove("highlight"),2000); }
}

searchBox.addEventListener("input",async ()=>{
    const q = searchBox.value.toLowerCase().trim();
    resultsDiv.innerHTML="";
    
    const definitionsList = document.getElementById("definitions-list");
    
    if(q.length<2) {
        resultsDiv.style.display = "none";
        definitionsList.style.display = "block";
        return;
    }

    // Ensure index is loaded
    if (!Array.isArray(searchIndex) || searchIndex.length === 0) {
        await loadSearchIndex();
        if (!Array.isArray(searchIndex) || searchIndex.length === 0) {
            resultsDiv.style.display = "block";
            definitionsList.style.display = "none";
            resultsDiv.innerHTML = `<div class="result t-card"><p>Loading index...</p></div>`;
            return;
        }
    }
    
    const words = q.split(/\s+/).filter(word => word.length > 0);
    const scoredMatches = searchIndex.map(raw => {
        const item = {
            file: raw.file || '',
            full_name: (raw.full_name || '').toString(),
            class: raw.class || null,
            summary: raw.summary || ''
        };
        const itemStr = JSON.stringify(item).toLowerCase();
        let score = 0;
        if (item.full_name.toLowerCase().includes(q)) score += 10;
        words.forEach(word => { if (itemStr.includes(word)) score += 1; });
        return { item, score };
    }).filter(({ score }) => score > 0)
      .sort((a, b) => b.score - a.score);
    
    if (scoredMatches.length > 0) {
        resultsDiv.style.display = "block";
        definitionsList.style.display = "none";
        scoredMatches.slice(0,20).forEach(({ item })=>{
            let summary = item.summary || '';
            if (summary && q.length > 0) {
                const regex = new RegExp(`(${words.join('|')})`, 'gi');
                summary = summary.replace(regex, '<mark>$1</mark>');
            }
            const href = `${item.file}.html#${encodeURIComponent(item.full_name)}`;
            resultsDiv.innerHTML += `<div class="result t-card">
                <a href="${href}">${item.full_name}</a>
                ${item.class?`<p><b>Class:</b> ${item.class}</p>`:""}
                <p>${summary}</p>
            </div>`;
        });
    } else {
        resultsDiv.style.display = "block";
        definitionsList.style.display = "none";
        resultsDiv.innerHTML = `<div class="result t-card"><p>No results found</p></div>`;
    }
});

// Tree view enhancer for sidebar definitions
function enhanceTree(root) {
    if (!root) return;
    root.classList.add('tree');

    // Mark all nested ULs and insert twisty buttons
    root.querySelectorAll(':scope > ul, :scope ul').forEach(ul => {
        const parentLi = ul.parentElement;
        if (!parentLi || parentLi.tagName.toLowerCase() !== 'li') return;

        // Create twisty
        const twisty = document.createElement('button');
        twisty.className = 'twisty';
        twisty.setAttribute('aria-label', 'toggle');
        twisty.textContent = '▸';

        // Wrap label text/link
        const labelSpan = document.createElement('span');
        labelSpan.className = 'label';

        // Move existing contents (text and anchors) before UL into labelSpan
        const childrenBeforeUL = [];
        for (let n = parentLi.firstChild; n && n !== ul; n = n.nextSibling) {
            childrenBeforeUL.push(n);
        }
        childrenBeforeUL.forEach(n => labelSpan.appendChild(n));

        // Determine if leaf (no child UL)
        const isLeaf = !ul || ul.children.length === 0;

        // Insert twisty and label at start
        parentLi.insertBefore(twisty, ul);
        parentLi.insertBefore(labelSpan, ul);

        if (isLeaf) {
            parentLi.classList.add('leaf');
        } else {
            // Default collapsed for deeper levels; keep top level expanded
            const depth = getDepth(parentLi, root);
            if (depth > 1) ul.classList.add('collapsed');

            const setExpanded = (expanded) => {
                ul.classList.toggle('collapsed', !expanded);
                twisty.textContent = expanded ? '▾' : '▸';
            };

            twisty.addEventListener('click', (e) => { e.stopPropagation(); setExpanded(ul.classList.contains('collapsed')); });
            labelSpan.addEventListener('click', () => setExpanded(ul.classList.contains('collapsed')));
        }
    });

    function getDepth(li, container){
        let d = 0; let n = li;
        while (n && n !== container) { if (n.tagName && n.tagName.toLowerCase() === 'ul') d++; n = n.parentElement; }
        return d;
    }

    // Controls
    const expandBtn = document.getElementById('expandAll');
    const collapseBtn = document.getElementById('collapseAll');
    if (expandBtn) expandBtn.addEventListener('click', () => {
        root.querySelectorAll('#definitions-list ul').forEach(ul => ul.classList.remove('collapsed'));
        root.querySelectorAll('#definitions-list .twisty').forEach(t => t.textContent = '▾');
    });
    if (collapseBtn) collapseBtn.addEventListener('click', () => {
        // Keep the top-level list expanded
        root.querySelectorAll('#definitions-list ul').forEach((ul, idx) => {
            const depth = (function getUlDepth(u){ let d=0, p=u; while(p && p.id !== 'definitions-list'){ if(p.tagName && p.tagName.toLowerCase()==='ul') d++; p=p.parentElement; } return d; })(ul);
            if (depth > 1) ul.classList.add('collapsed'); else ul.classList.remove('collapsed');
        });
        root.querySelectorAll('#definitions-list .twisty').forEach(t => t.textContent = '▸');
        // Fix top-level twisties to expanded symbol
        root.querySelectorAll('#definitions-list > ul').forEach(ul => {
            const li = ul.parentElement;
            const tw = li && li.querySelector(':scope > .twisty');
            if (tw) tw.textContent = '▾';
        });
    });
}

// Auto-expand tree to the current page/hash
function expandToCurrent() {
    const defList = document.getElementById('definitions-list');
    if (!defList) return;
    const current = (location.pathname.split('/').pop() || '').toLowerCase();
    const currentBase = current.replace(/\.html$/, '');
    const hash = decodeURIComponent((location.hash || '').replace(/^#/, ''));

    const anchors = Array.from(defList.querySelectorAll('a[href]'));
    let targetA = null;
    if (hash) {
        targetA = anchors.find(a => a.getAttribute('href') === `${currentBase}.html#${hash}`);
    }
    if (!targetA) {
        targetA = anchors.find(a => (a.getAttribute('href') || '').startsWith(`${currentBase}.html#`)) || null;
    }

    if (targetA) {
        // Expand all ancestor ULs and set twisties to expanded
        let n = targetA.parentElement;
        while (n && n.id !== 'definitions-list') {
            if (n.tagName && n.tagName.toLowerCase() === 'ul') {
                n.classList.remove('collapsed');
            }
            if (n.tagName && n.tagName.toLowerCase() === 'li') {
                const tw = n.querySelector(':scope > .twisty');
                if (tw) tw.textContent = '▾';
            }
            n = n.parentElement;
        }
        // Highlight and scroll into view
        const li = targetA.closest('li');
        if (li) {
            li.classList.add('highlight');
            targetA.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => li.classList.remove('highlight'), 2000);
        }
    }
}

 // Initialize on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    const defList = document.getElementById('definitions-list');
    enhanceTree(defList);
    expandToCurrent();
});

// Prism initialization handled automatically
</script>
</body>
</html>